---
layout: post
title: "Тестовое задание №2"
type: project
---

## Задача на знание командной строки.  
К вакансии Инженер по тестированию беспилотных транспортных [средств](https://yandex.ru/jobs/vacancies/testing/test_engineer_drone/)

### Задача  
Для отладки работы одного из модулей вам необходимо отправить лог разработчику.  
Исходный формат лога:  
```  
Jul 6 17:35:10 sdc-prius motion_planner[1284]: new destination: [55.733510, 37.587401]  
Jul 6 17:35:11 sdc-prius control[1284]: next waypoint: [55.733668, 37.587143]  
Jul 6 17:35:11 sdc-prius control[1281]: steering: 212, throttle: 420  
Jul 6 17:35:11 sdc-prius control[1281]: steering: 145, throttle: 634  
Jul 6 17:35:12 sdc-prius control[1281]: steering: 65, throttle: 538  
Jul 6 17:35:13 sdc-prius control[1284]: next waypoint: [55.733948, 37.586731]  
Jul 6 17:35:13 sdc-prius control[1281]: steering: 121, throttle: 340  
Jul 6 17:35:13 sdc-prius control[1281]: steering: 150, throttle: 600  
Jul 6 17:35:14 sdc-prius control[1281]: steering: 46, throttle: 346  
Jul 6 17:35:13 sdc-prius control[1284]: next waypoint: [55.733955, 37.586744]  
Jul 6 17:35:13 sdc-prius control[1281]: steering: 485, throttle: 567  
Jul 6 17:35:13 sdc-prius control[1284]: next waypoint: [55.734094, 37.586518]  
Jul 6 17:35:14 sdc-prius control[1281]: steering: 278, throttle: 400  
Jul 6 17:35:14 sdc-prius control[1284]: next waypoint: [55.734300, 37.586229]  
Jul 6 17:35:14 sdc-prius control[1281]: steering: 982, throttle: 400  
Jul 6 17:35:14 sdc-prius control[1284]: next waypoint: [55.734530, 37.585896]  
Jul 6 17:35:14 sdc-prius control[1281]: steering: 98, throttle: 400  
Jul 6 17:35:15 sdc-prius control[1284]: next waypoint: [55.733948, 37.586731]  
Jul 6 17:35:15 sdc-prius control[1281]: steering: 33, throttle: 200  
Jul 6 17:35:15 sdc-prius motion_planner[1284]: new destination: [55.734839, 37.585531]  
Jul 6 17:35:15 sdc-prius control[1281]: steering: 2, throttle: 100  
```  

Формат для отправки:  
```  
Jul 6 17:35:11 37.587143, 55.733668  
Jul 6 17:35:13 37.586731, 55.733948  
Jul 6 17:35:13 37.586744, 55.733955  
Jul 6 17:35:13 37.586518, 55.734094  
Jul 6 17:35:14 37.586229, 55.734300  
Jul 6 17:35:14 37.585896, 55.734530  
Jul 6 17:35:15 37.586731, 55.733948  
```  

Напишите консольную команду, с помощью которой вы бы подготовили лог для отправки.  

### Решение 1 - grep+awk  
Проанализируем формат логов для отправки. В нем указаны пять столбцов, по порядку: месяц число время координата2, координата1  

Как видно только в части исходных строк есть координаты. Следовательно, нужно выделить эти строки из общей массы. Однако тут есть одна особенность. 
Не все строки с координатами попали в итоговый ответ, например нет:  
>Jul 6 17:35:15 sdc-prius motion_planner[1284]: new destination: [55.734839, 37.585531]  

В ответ попали те, в которых встречается слово 'waypoint'. Используя это слово как ключевое, выделим нужные строки используя комманду grep:  

> \>\>grep waypoint  
Jul 6 17:35:11 sdc-prius control[1284]: next waypoint: [55.733668, 37.587143]  
Jul 6 17:35:13 sdc-prius control[1284]: next waypoint: [55.733948, 37.586731]  
Jul 6 17:35:13 sdc-prius control[1284]: next waypoint: [55.733955, 37.586744]  
Jul 6 17:35:13 sdc-prius control[1284]: next waypoint: [55.734094, 37.586518]  
Jul 6 17:35:14 sdc-prius control[1284]: next waypoint: [55.734300, 37.586229]  
Jul 6 17:35:14 sdc-prius control[1284]: next waypoint: [55.734530, 37.585896]  
Jul 6 17:35:15 sdc-prius control[1284]: next waypoint: [55.733948, 37.586731]  

Далее нужно выбрать столбцы: 1, 2, 3, 8, 9. Для этого отлично подойдет комманда awk. 
В ней используем метод print для вывода обработанных данных в стандартный поток вывода и нумерованные аргументы со знаком $ для вывода определенных столбцов.
Передадим ей данные стандартного потока вывода grep с помощью символа | и выведем через метод print только нужные нам столбцы:  
> \>\>grep waypoint | awk '{print $1,$2,$3,$8,$9}'  
Jul 6 17:35:11 [55.733668, 37.587143]  
Jul 6 17:35:13 [55.733948, 37.586731]  
Jul 6 17:35:13 [55.733955, 37.586744]  
Jul 6 17:35:13 [55.734094, 37.586518]  
Jul 6 17:35:14 [55.734300, 37.586229]  
Jul 6 17:35:14 [55.734530, 37.585896]  
Jul 6 17:35:15 [55.733948, 37.586731]  

Уже близко. Надо поменять местами последние два столбца. Меняем:  
> \>\>grep waypoint | awk '{print $1,$2,$3,$9,$8}'  
Jul 6 17:35:11 37.587143] [55.733668,  
Jul 6 17:35:13 37.586731] [55.733948,  
Jul 6 17:35:13 37.586744] [55.733955,  
Jul 6 17:35:13 37.586518] [55.734094,  
Jul 6 17:35:14 37.586229] [55.734300,  
Jul 6 17:35:14 37.585896] [55.734530,  
Jul 6 17:35:15 37.586731] [55.733948,  

Осталось избавиться от квадратных скобок и перенести запятую на место после первой координаты. В этом поможет метод substr() присутствующий в awk. 
Он посимвольно выделяет подстроку в строке. В качестве аргументов принимает: строку, количество пропускаемых символов с начала строки и количество символов подстроки. То что нужно.  
В первой координате, чтобы исключить скобку надо выделить первые 9 символов обозначающих координату - substr($9, 0, 9).  
Во второй координате, чтобы исключить пробел, скобку и запятую в конце, надо выделить 9 символов обозначающих координату, начиная со второго символа - substr($8, 2, 9).  
И поставим запятую между этими аргументами используя двойные кавычки. Итоговая комманда будет выглядеть так:  

> \>\>grep waypoint | awk '{print $1,$2,$3,substr($9, 0, 9)",",substr($8, 2, 9)}'  
Jul 6 17:35:11 37.587143, 55.733668  
Jul 6 17:35:13 37.586731, 55.733948  
Jul 6 17:35:13 37.586744, 55.733955  
Jul 6 17:35:13 37.586518, 55.734094  
Jul 6 17:35:14 37.586229, 55.734300  
Jul 6 17:35:14 37.585896, 55.734530  
Jul 6 17:35:15 37.586731, 55.733948  

## Решение 2 - awk  
Комманда awk позволяет использовать ключевые слова для отбора нужных строк. Так же как это делает комманда grep. Для этого ключевое слово необходимо заключить между двух слешей.  
Модифицируем итоговую комманду:  
> \>\>awk '/waypoint/ {print $1,$2,$3,substr($9, 1, 9)",",substr($8, 2, 9)}'  

Получаем тот же ответ.  

## Решение 3 - sed  
Так же для решения данной задачи можем воспользоваться коммандой sed. Она позволяет использовать сложные регулярные выражения с группировкой для работы со строками.  
Формат комманды sed 's/регулярное выражение/группа/флаг'. Составим регулярное выражение для задачи.  
Первое, выделим первую группу с датой и временем  
>'\(.*\) sdc.*/\1'  

Второе, выберем строки в которых есть ключевое слово waypoint  
>'\(.*\) sdc.*waypoint.*/\1'  

Третье, выделим во вторую группу первую координату. Она расположена после квадратной скобки до первой запятой  
>'\(.*\) sdc.*waypoint.*\[\(.*\), .*/\1 \2'  

Четвертое, выделим в третью группу вторую координату. Она распологается сразу после запятой и пробела, 
следующими за второй группой до первой квадратной скобки  
>'\(.*\) sdc.*waypoint.*\[\(.*\), \(.*\)\]/\1 \2 \3'  

Пятое, поменяем группу 2 и 3 с координатами местами и поставим после первой запятую  
>'\(.*\) sdc.*waypoint.*\[\(.*\), \(.*\)\]/\1 \3, \2'  

Чтобы исключить из стандартного потока вывода лишние строки и при этом отобразить отформатированные добавим к команде ключ -n, а к выражению флаг p.   
Запишем регулярное выражение в комманду:  
> \>\>sed 's/\(.*\) sdc.*waypoint.*\[\(.*\), \(.*\)\]/\1 \3, \2/'  

Если лог принимается и передается в файлах вида log.txt и log_to_send.txt, то команду подготовки логов можно дополнить командами чтения и записи в файл. Например:
> \>\>awk '/waypoint/ {print $1,$2,$3,substr($9, 1, 9)",",substr($8, 2, 9)}' log.txt > log_to_send.txt
